---
title: PWA ç¦»çº¿ç¼“å­˜æŠ€æœ¯åœ¨å¤§å‹ B ç«¯ç«™ç‚¹çš„åº”ç”¨ä¸å®è·µ
date: 2022-09-03 9:30:00
tags: 
  - ç¦»çº¿ç¼“å­˜
  - Service Worker
  - PWA
categories: å‰ç«¯
---

æˆ‘ä»¬å›¢é˜Ÿè´Ÿè´£çš„æŸè¿è¥å¹³å°çš„å»ºè®¾ï¼Œéšç€é¡¹ç›®çš„ä¸æ–­è¿­ä»£ï¼Œå„ç§éœ€æ±‚ä¸åŠŸèƒ½çš„å¢åŠ ï¼Œç›®å‰å„ä¸ªå­æ¨¡å—è¶…è¿‡äº†æ•°ç™¾ä¸ªï¼Œç«™ç‚¹åŠ è½½æ…¢çš„é—®é¢˜ä¹Ÿé€æ¸æ˜¾ç°ï¼Œç›¸å…³æŒ‡æ ‡è¶‹äºæ¶åŒ–ã€‚é€šè¿‡è°ƒç ”å‘ç°ï¼Œä¸»è¦åŸå› æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š

1.  é¡µé¢åˆå§‹åŒ–ä¾èµ–çš„æ¥å£è¾ƒå¤šï¼Œå…¶ä¸­ä¸ä¹åŒ…æ‹¬æƒé™ã€åœ°åŒºã€é¡¹ç›®é…ç½®ç­‰ç›¸å…³æ¥å£ï¼Œè€Œä¸”ç”±äºå†å²åŸå› ï¼Œè¿™äº›æ¥å£çš„å“åº”é€Ÿåº¦è¾ƒæ…¢ï¼Œæ”¹é€ æˆæœ¬è¾ƒé«˜ã€‚

2.  åŸºäºå¾®å‰ç«¯+SPAåº”ç”¨æ¶æ„çš„åŠ è½½é“¾è·¯è¾ƒé•¿ï¼Œä¸»åº”ç”¨åŠ è½½å®Œæˆåè¿˜éœ€è¦è¯·æ±‚ç½‘ç»œï¼ŒåŠ è½½å­åº”ç”¨çš„é¡µé¢åŠå…¶èµ„æºï¼Œå¯¼è‡´å­åº”ç”¨æœ‰è¾ƒé•¿çš„ç™½å±æ—¶é—´ã€‚ä¸‹å›¾å±•ç¤ºäº†ç›®å‰ç«™ç‚¹åŸæœ‰çš„åŠ è½½é“¾è·¯ã€‚

![ç«™ç‚¹åŠ è½½æµç¨‹](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/image-20220828114655255.png)


ä¸ºäº†åŠ å¿«é¡µé¢çš„åŠ è½½é€Ÿåº¦ï¼Œå‡å°‘èµ„æºå’Œæ¥å£çš„æ…¢è¯·æ±‚ç‡ï¼Œé‡‡ç”¨ PWA ç¦»çº¿ç¼“å­˜çš„æŠ€æœ¯ï¼Œå°†ç›¸å…³çš„é¡µé¢ã€èµ„æºå’Œè¯·æ±‚è¿›è¡Œç¦»çº¿ç¼“å­˜ï¼Œå¹¶åœ¨åŠ è½½çš„äº¤äº’ä¸Šè¿›è¡Œæ”¹è¿›ï¼Œæ•´ä½“æå‡äº†ç«™ç‚¹çš„ä½¿ç”¨ä½“éªŒï¼Œå¹¶å¸®åŠ©è¿è¥åŒå­¦æå‡å·¥ä½œæ•ˆç‡ã€‚

#### æŠ€æœ¯æ–¹æ¡ˆé€‰å‹

é¦–å…ˆæ€è€ƒä¸‹é¢ä¸‰ä¸ªé—®é¢˜ï¼š

1.  ä¸ºä»€ä¹ˆé€‰æ‹©ä½¿ç”¨ PWAï¼Ÿ
2.  ä¸ºä»€ä¹ˆæœ‰äº† HTTP ç¼“å­˜è¿˜éœ€è¦åšç¦»çº¿ç¼“å­˜ï¼Ÿ
3.  B ç«¯äº§å“æ˜¯å¦é€‚åˆæ¥å…¥ï¼Ÿ

å…¶å® PWAï¼ˆProgressive web applicationï¼‰æŠ€æœ¯å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°å¥‡çš„æ¦‚å¿µï¼Œè¿‘äº›å¹´çš„åº”ç”¨æ¯”è¾ƒå¹¿æ³›ï¼Œå› æ­¤æŠ€æœ¯ç›¸å¯¹æ¯”è¾ƒæˆç†Ÿã€‚é€šè¿‡æ“ä½œæµè§ˆå™¨æä¾›çš„ Service Worker APIï¼Œå¯ä»¥ç¦»çº¿ç¼“å­˜æ¥å£æ•°æ®ã€é™æ€èµ„æºï¼Œå¤§å¹…é™ä½è¯·æ±‚å¤„ç†é€Ÿåº¦ï¼Œç¼©çŸ­é¦–å±åŠ è½½æ—¶é•¿ï¼Œè¾¾åˆ°å’ŒåŸç”Ÿåº”ç”¨æ¥è¿‘çš„ä½“éªŒã€‚åƒæ˜¯æ¨é€é€šçŸ¥ã€é€šçŸ¥åŠŸèƒ½å’Œæ·»åŠ è‡³ä¸»å±åŠŸèƒ½ä¹Ÿå¾—åˆ°äº†å¹¿æ³›çš„æ”¯æŒã€‚**æ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬åªéœ€è¦ç›¸å¯¹è¾ƒå°çš„ä»£ä»·å°±å¯ä»¥å®ç° PWA çš„æ ¸å¿ƒç‰¹æ€§ï¼Œè€Œå¸¦æ¥çš„æ”¶ç›Šå´æ˜¯éå¸¸å¯è§‚çš„ã€‚**

å¯¹äºä½¿ç”¨äº† PWA æŠ€æœ¯çš„åº”ç”¨æ¥è¯´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæµè§ˆå™¨ç«¯åœ¨è¯·æ±‚èµ„æºæ—¶ä¼šéµå¾ª ServiceWorker Cache > Disk Cache çš„ä¼˜å…ˆçº§é¡ºåºï¼Œè€Œè¿™ä¸¤ç§ç¼“å­˜çš„åŠ è½½é€Ÿåº¦åˆ†åˆ«ä¸º Disk Cache > ServiceWorker Cacheã€‚å¦å¤–ï¼Œä¸€äº›ç°ä»£æµè§ˆå™¨è¿˜ä¼šæœ‰ Memory Cacheï¼Œè¿™ç§ç¼“å­˜çš„ä¼˜å…ˆçº§ä»¥åŠåŠ è½½é€Ÿåº¦å‡ä¼˜äº Service Cache å’Œ Disk Cacheã€‚

![ç¼“å­˜é¡ºåº](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/1280X1280%20(2).png)


å›¾ç‰‡æ¥æºï¼š[Web.Dev](https://web.dev/i18n/zh/service-worker-caching-and-http-caching/)

é‚£ä¹ˆåœ¨ä¹‹å‰ç«™ç‚¹çš„å¤§éƒ¨åˆ†èµ„æºå·²ç»åšäº† HTTP ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆè¿˜è¦åšç¦»çº¿ç¼“å­˜å‘¢ï¼Ÿï¼ˆPSï¼šå°å­©å­æ‰åšé€‰æ‹©ï¼Œå¤§äººå…¨éƒ½è¦ã€‚ï¼‰å…¶å®äºŒè€…å¹¶ä¸å†²çªï¼Œç»è¿‡è°ƒç ”å‘ç°ï¼Œä¸¤è€…çš„ç¼“å­˜è·å–çš„æ—¶é—´ç›¸å·®ä¸ºæ¯«ç§’çº§ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œè€Œåœ¨å¹¶å‘è¯·æ±‚æ•°é‡è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œ [Service Worker Cache é€Ÿåº¦æ¯” Disk Cache æ›´å¿«](https://segmentfault.com/a/1190000041736677)ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡èµ„æºç«é€Ÿçš„æ–¹å¼ï¼Œæ‹¿åˆ°æœ€å¿«çš„èµ„æºã€‚æœ€é‡è¦çš„æ˜¯ï¼Œç¦»çº¿ç¼“å­˜ç»™æˆ‘ä»¬å¸¦æ¥çš„æœ€æ˜¾è‘—çš„æ”¶ç›Šæ˜¯ä¼˜åŒ–äº†å¾®å‰ç«¯ + SPA çš„åŠ è½½é“¾è·¯è¿‡é•¿çš„é—®é¢˜ï¼Œé€šè¿‡æ›´ç»†ç²’åº¦ä»¥åŠå¯æ§çš„ç¼“å­˜ï¼Œæ¥åˆå§‹åŒ–é¡µé¢çš„è¯·æ±‚ä»¥åŠä¸»å­åº”ç”¨çš„ App-shell å’Œèµ„æºï¼ŒåŠ å¿«é¡µé¢çš„åŠ è½½é€Ÿåº¦ï¼Œå‡å°‘ç™½å±æ—¶é—´ã€‚

å¦å¤–ï¼Œä½œä¸ºä¸€ä¸ª B ç«¯äº§å“ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·ç¾¤ä½“æ˜¯å•ä¸€å’Œå›ºå®šçš„ï¼Œä½†æ˜¯é¡µé¢çš„è®¿é—®é¢‘æ¬¡ç›¸å¯¹è¾ƒé«˜ï¼ŒService Worker æ¥å£è¯·æ±‚çš„ç¼“å­˜ç­–ç•¥éå¸¸é€‚åˆæˆ‘ä»¬çš„æ¥å£ä¼˜åŒ–ã€‚åŒæ—¶PWA çš„æ”¹é€ æˆæœ¬ç›¸å¯¹è¾ƒå°ï¼Œç»™æˆ‘ä»¬å¸¦æ¥æ”¶ç›Šç¡®å®å¾ˆå¯è§‚ï¼Œé™¤äº†ç¼“å­˜ä¼˜åŒ–å¤–ï¼Œåœ¨ä¹‹åæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ PWA æä¾›çš„é€šçŸ¥æ¨é€ã€æ·»åŠ ä¸»å±çš„åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æå‡ç”¨æˆ·ä½“éªŒï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹© PWA çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚

### æ’ä»¶å¯¹æ¯”

æˆ‘ä»¬ç«™ç‚¹çš„æ„å»ºå·¥å…·ä¸ºå­—èŠ‚å†…éƒ¨çš„å·¥å…·ï¼Œæä¾›äº†é…å¥—çš„ pwa æ’ä»¶ï¼Œè¿™é‡Œä¸ Google æä¾›çš„ webpack æ’ä»¶åšä¸€ä¸ªå¯¹æ¯”ã€‚

|      | å†…éƒ¨æ’ä»¶                                                     | [workbox-webpack-plugin](https://www.npmjs.com/package/workbox-webpack-plugin) |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ä»‹ç» | å¯¹[workbox-webpack-plugin](https://www.npmjs.com/package/workbox-webpack-plugin)æ’ä»¶çš„å°è£… | å·¥å…·åº“ï¼Œæä¾›äº†ä¸€ç³»åˆ—å¯¹ Service Work æ“ä½œçš„ API               |
| éƒ¨ç½² | æ•´åˆäº†éƒ¨ç½²çš„èƒ½åŠ›ï¼Œä¸ç”¨å•ç‹¬é…ç½®éƒ¨ç½²çš„è·¯ç”±                     | éœ€è¦å¢åŠ ä¸€ä¸ª sw.js çš„è·¯ç”±                                    |
| é…ç½® | é…ç½®ç®€å•ï¼Œä½†æ˜¯é…ç½®é¡¹å¤ªå°‘ï¼Œåªèƒ½è¦†ç›–åˆ°ä¸€å°éƒ¨åˆ†åœºæ™¯ï¼Œé€‚åˆå°å‹çš„åº”ç”¨ | é…ç½®æœ‰ç‚¹å¤æ‚ï¼Œæ‰‹å†™çš„ä¸œè¥¿è¾ƒå¤šï¼Œä½†æ˜¯èƒ½å¤Ÿè¦†ç›–åˆ°å¤§éƒ¨åˆ†åœºæ™¯ã€‚     |
| æ‰“åŒ… | è‡ªåŠ¨ç”Ÿæˆ service-worker.js æ–‡ä»¶ï¼Œhtml è‡ªåŠ¨æ³¨å…¥ Service Worker æ³¨å†Œçš„script | è‡ªåŠ¨ç”Ÿæˆ service-worker.js æ–‡ä»¶ï¼ŒService Worker æ³¨å†Œéœ€è¦æ‰‹å†™ï¼Œå› æ­¤å¯ä»¥è‡ªå®šä¹‰é™çº§æ–¹æ¡ˆ |

æ ¹æ®ä¸Šè¿°å¯¹æ¯”ï¼Œå‘ç° workbox-webpack-plugin çš„è‡ªå®šä¹‰é…ç½®é¡¹æ›´ä¸°å¯Œï¼Œèƒ½å¤Ÿè¦†ç›–æ­¤æ¬¡æ”¹é€ éœ€æ±‚çš„åœºæ™¯ï¼Œå¯ä»¥è‡ªå®šä¹‰é™çº§æ–¹æ¡ˆï¼Œå› æ­¤é€‰ç”¨ workbox-webpack-plugin æ’ä»¶è¿›è¡Œ PWA çš„é…ç½®ã€‚

### Service Worker ç¦»çº¿ç¼“å­˜

é¡µé¢åˆæ¬¡åŠ è½½ Service Worker å¤„äºæœªè¢«æ¿€æ´»çš„çŠ¶æ€ï¼Œæ— æ³•æ‹¦æˆªé¡µé¢çš„è¯·æ±‚è¿›è¡Œç¼“å­˜ã€‚åªæœ‰å¤„äº activated çŠ¶æ€åæ‰ä¼šæ¥ç®¡é¡µé¢çš„è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€é¡µé¢ä¾ç„¶ä¼šè¯·æ±‚æ‰€æœ‰çš„èµ„æºï¼Œåœ¨å®‰è£… Service Worker ä¹‹åï¼Œéœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½æœ‰ç¼“å­˜çš„æ•ˆæœã€‚

![](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/screenshot-20220830-104307.png)



#### ç¼“å­˜ç­–ç•¥

| **Cache First**                                              | **Network First**                                            | **StaleWhileRevalidate**                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜ä¸å­˜åœ¨è¯·æ±‚ç½‘ç»œ                             | ä¼˜å…ˆä½¿ç”¨ç½‘ç»œè¯·æ±‚ï¼Œç½‘ç»œå¼‚å¸¸æƒ…å†µä½¿ç”¨ç¼“å­˜                       | ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜ä¸å­˜åœ¨ä½¿ç”¨ç½‘ç»œï¼›ç¼“å­˜å­˜åœ¨åˆ™å…ˆä½¿ç”¨ç¼“å­˜ï¼ŒåŒæ—¶åœ¨åå°è¯·æ±‚ç½‘ç»œèµ„æºæ›´æ–°ç¼“å­˜ |
| ![img](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/(null).jpg) å›¾ç‰‡æ¥æºï¼š[Google Developers](https://developer.chrome.com/docs/workbox/modules/workbox-strategies/) | ![img](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/(null)-20220828114924137.(null)) | ![img](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/(null)-20220828114930732.(null)) |

#### Precache vs Runtime Cache

Service Worker é‡Œçš„ç¼“å­˜åˆ†ä¸º Precache å’Œ Runtime Cacheã€‚

Precache å³é¢„ç¼“å­˜ï¼Œå®ƒåœ¨ build é˜¶æ®µäº§ç”Ÿä¸€ä¸ªåä¸º workbox-precaching é¢„ç¼“å­˜æ¸…å•ï¼Œä½¿buildäº§ç‰©ä¿æŒæœ€æ–°ï¼Œå¹¶ä½¿ç”¨ç¼“å­˜ä¼˜å…ˆç­–ç•¥è®¾ç½®è·¯ç”±ä»¥æä¾›é¢„ç¼“å­˜çš„ URLã€‚åªè¦ä¸€æ‰“å¼€é¡µé¢ï¼Œå®ƒå°±ä¼šåœ¨åå°æŠŠæ¸…å•é‡Œèµ„æºå»è¯·æ±‚ä¸€éå¹¶è¿›è¡Œç¼“å­˜ï¼Œè€Œä¸éœ€è¦ç­‰åˆ°æµè§ˆå™¨æ¥ç®¡ç›¸åº”çš„è¯·æ±‚åå†ç¼“å­˜ã€‚

Runtime Cache æ˜¯è¿è¡Œæ—¶é¢„ç¼“å­˜ï¼Œå³åœ¨é¡µé¢çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œåªè¦å‘½ä¸­äº†æ‰€è®¾ç½®çš„è·¯ç”±è§„åˆ™ï¼Œå°±å¾€ Service Worker ä¸­è®°å½•ä¸€æ¡ã€‚

é€šå¸¸æ¥è¯´ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€é¡µé¢ï¼Œä¼šåœ¨åå°ç¼“å­˜ Precache çš„èµ„æºï¼Œç¬¬äºŒæ¬¡åˆ·æ–°åå³å¯ä½¿ç”¨ã€‚å¦‚æœæ˜¯ Runtime çš„ç¼“å­˜ï¼Œä¸€èˆ¬éœ€è¦ç­‰åˆ°ç¬¬ä¸‰æ¬¡åˆ·æ–°æ‰èƒ½å¤Ÿä½¿ç”¨ã€‚

#### Service Worker æ›´æ–°ç­–ç•¥

é»˜è®¤æƒ…å†µï¼Œå½“ç›‘æµ‹åˆ°æœ‰æ–°çš„ Service Workerï¼Œä¼šç»å†ä¸¤ä¸ªé˜¶æ®µï¼š

1.  å†æ¬¡è§¦å‘ intall äº‹ä»¶ï¼Œä½†å¦‚æœé¡µé¢æ²¡å…³é—­ï¼Œé¡µé¢ä¾æ—§è¢«è€çš„ Service Worker æ‰˜ç®¡ï¼Œæ–°çš„ Service Worker å¤„äº waiting çŠ¶æ€ã€‚
    
2.  å½“ç”¨æˆ·å®Œå…¨å…³é—­é¡µé¢åï¼ˆæµè§ˆå™¨æ‰€æœ‰çš„tabéƒ½æ²¡æœ‰æ‰“å¼€è¯¥ç«™ç‚¹ï¼‰ï¼Œå¹¶å†æ¬¡æ‰“å¼€é¡µé¢æ‰ä¼šè§¦å‘ activate äº‹ä»¶ã€‚æ­¤æ—¶æ–°çš„ Service Worker æ¥ç®¡é¡µé¢ï¼Œæ–°çš„ç¼“å­˜ä¹Ÿä¼šå¼€å§‹ç”Ÿæ•ˆã€‚
    

è€ƒè™‘åˆ°ç”¨æˆ·ä¼šæœ‰æ‰“å¼€å¤šä¸ª Tab çš„ä¹ æƒ¯ï¼Œè¿™ç§æ–¹æ¡ˆæ— æ³•é€šè¿‡ç®€å•çš„åˆ·æ–°é¡µé¢æ¥çœ‹åˆ°æœ€æ–°çš„æ•ˆæœï¼Œéœ€è¦å…³é—­æ‰€æœ‰ç›¸å…³çš„ Tab æ‰å¯ä»¥ï¼Œå¯¹ç”¨æˆ·ä½¿ç”¨å¿ƒæ™ºä¸å¤ªå‹å¥½ã€‚

è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡ `skipWaiting` æ–¹æ³•ç›´æ¥åˆ·æ–°ï¼Œä½†è¿™æ ·å¯èƒ½å‡ºç°ç¼“å­˜å†²çªçš„æƒ…å†µã€‚ å› ä¸ºæ³¨å†ŒService Workeræ˜¯ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œå¯èƒ½å‡ºç°åŒä¸€ä¸ªé¡µé¢å‰åç»è¿‡ä¸¤ä¸ª Service Workerï¼Œå°±æœ‰[å­˜åœ¨é—®é¢˜çš„é£é™©](https://stackoverflow.com/questions/51715127/what-are-the-downsides-to-using-skipwaiting-and-clientsclaim-with-workbox?noredirect=1&lq=1)ã€‚ä¾‹å¦‚æœ‰æ–°åŠŸèƒ½ä¸Šçº¿åï¼Œç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œéƒ¨åˆ†èµ„æºèµ°çš„è€çš„ç¼“å­˜ï¼Œæ–°çš„ Service Worker æ³¨å†Œå¥½åï¼Œå¦‚æœè€çš„ç¼“å­˜é‡Œæœ‰å¼‚æ­¥è¯·æ±‚ï¼Œåˆ™ç¼“å­˜å’Œçº¿ä¸Šéƒ½æ— æ³•å‘½ä¸­ï¼Œå¯¼è‡´èµ„æºè¯·æ±‚å¤±è´¥ã€‚

| **é»˜è®¤æ–¹å¼**                                      | **skipWaiting**                                            |
| ------------------------------------------------- | ---------------------------------------------------------- |
| éœ€è¦å…³é—­æ‰€æœ‰ tabï¼Œæ–°çš„ç¼“å­˜æ‰ä¼šç”Ÿæ•ˆ                | åˆ·æ–°å½“å‰é¡µé¢ï¼Œç¼“å­˜ç«‹å³ç”Ÿæ•ˆ                                 |
| ä¼˜ç‚¹ï¼š æœ€å®‰å…¨ï¼Œæ²¡æœ‰é£é™©ç¼ºç‚¹ï¼šç”¨æˆ·ä½¿ç”¨å¿ƒæ™ºä¸å¤ªå‹å¥½ | ä¼˜ç‚¹ï¼šç”¨æˆ·æ— æ„ŸçŸ¥ç¼ºç‚¹ï¼šæ½œåœ¨é—®é¢˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¼‚æ­¥èµ„æºè¯·æ±‚å¤±è´¥ |

é€šè¿‡å¯¹æ¯”æ–¹æ¡ˆï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ç§æ–¹å¼å‡æœ‰ä¸å¦¥ï¼ŒæŠ€æœ¯ä¸æ˜¯ä¸‡èƒ½ï¼Œæœ‰ç¼ºç‚¹éœ€è¦äº§å“é€»è¾‘è¿›è¡Œç»“åˆå¼¥è¡¥ã€‚æˆ‘ä»¬ä½¿ç”¨ postMessage + skipWaiting çš„æ›´æ–°æ–¹å¼ï¼Œé¡µé¢ç›‘å¬ `message` äº‹ä»¶ï¼Œå¹¶åœ¨å›è°ƒä¸­åˆ·æ–°é¡µé¢ã€‚å…·ä½“çš„è¡¨ç°å½¢å¼ä¸ºå½“é¡µé¢æ£€æµ‹åˆ°æœ‰æ–°çš„ Service Worker æ³¨å†Œæ—¶ï¼Œé¡µé¢å¼¹å‡ºæç¤ºæ¡†ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢ã€‚å½“ç”¨æˆ·ç‚¹å‡» Load New æŒ‰é’®æ—¶ï¼Œé€šè¿‡ postMessage API å‘é€ä¸€æ¡é€šçŸ¥ï¼Œæ‰€æœ‰é¡µé¢å³ä¼šåˆ·æ–°å¹¶è·å–åˆ°æœ€æ–°ç¼“å­˜ã€‚

![Service Worker æ›´æ–°æç¤º](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/(null)-20220828115029882.(null))

### èµ„æºç¼“å­˜

#### Build æ‰“åŒ…èµ„æº

ç¼–è¯‘äº§ç‰©é‡‡ç”¨ CacheFirst æ–¹æ¡ˆåšé¢„å­˜å‚¨ï¼ˆpreCacheï¼‰ï¼Œæ¯æ¬¡æ›´æ–°æ—¶æ ¹æ®æ–‡ä»¶ hash æˆ–è€…æ–‡ä»¶ revision æ ‡è¯†è¿›è¡Œç¼“å­˜çŠ¶æ€æ›´æ–°ã€‚

[workbox-webpack-plugin](https://www.npmjs.com/package/workbox-webpack-plugin) ä¼šè¯†åˆ«ä¸€ä¸ª `__WB_MANIFEST` ç‰¹æ®Šå˜é‡ï¼Œåœ¨æ„å»ºç»“æœä¸­è¯¥å˜é‡ä¼šæ›¿æ¢æˆmanifest arrayã€‚æ¯æ¬¡æ‰“åŒ…æ„å»ºï¼Œç”Ÿæˆçš„æ–‡ä»¶ä¼šæ›´æ–°ï¼Œè¿›è€Œè§¦å‘ Service Worker æ›´æ–°ã€‚

```JavaScript
// self.__WB_MANIFEST ä»£æŒ‡ build çš„æ–‡ä»¶åˆ—è¡¨
[
  {
    'revision': '23fadff0671aa',
     'url': '/common/137.ff0671aa3b.js'
  }, 
  {
    'revision': '6324c478f69e3',
    'url': '/common/632.4c478f69e3.js'
  }
]
```

```JavaScript
// generate sw.js config
precacheAndRoute(
    // __WB_MANIFEST æ˜¯ workbox-webpack-plugin å†…ç½®çš„ä¸€ä¸ªå˜é‡ï¼Œbuild åä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºæ›¿æ¢ä¸ºé¢„ç¼“å­˜æ¸…å•
    self.__WB_MANIFEST.filter(
      i =>i.url.endsWith('js') || i.url.endsWith('css'),
    ),
  );
```

#### ä¸‰æ–¹é™æ€èµ„æº

-   å­—ä½“ã€å›¾ç‰‡ã€å›¾æ ‡
    
-   SDKï¼Œç«™ç‚¹ä¸­åŒ…æ‹¬ç›‘æ§ã€æ‰“ç‚¹ã€Oncall å®¢æœ SDK ç­‰ç­‰
    

å¯¹äºå­—ä½“æ–‡ä»¶ï¼Œå›¾ç‰‡ï¼Œä»¥åŠå¸¦ç‰ˆæœ¬å·çš„ç¬¬ä¸‰æ–¹sdkï¼Œé‡‡ç”¨ Cache First ç­–ç•¥ï¼Œè®¾ç½® 30 å¤©çš„ç¼“å­˜æ—¶é—´ã€‚å¯¹äºå…¶ä»–çš„é™æ€èµ„æºï¼ˆä¸åŒ…å« build äº§ç‰©ï¼‰ï¼Œä¾‹å¦‚å¤–éƒ¨çš„æ ·å¼ã€ä¸å¸¦ç‰ˆæœ¬å·çš„ sdkï¼Œé‡‡ç”¨ StaleWhileRevalidate ç­–ç•¥ã€‚åœ¨å‘½ä¸­ç¼“å­˜çš„åŒæ—¶ï¼Œåå°è¯·æ±‚æœ€æ–°çš„èµ„æºå¹¶è¿›è¡Œæ›´æ–°ï¼Œä¿è¯èµ„æºçš„å®æ—¶æ€§ã€‚

```JavaScript
const staleWhileRevalidate = (cacheName, maxEntries) => new StaleWhileRevalidate()

const cacheFirst = (cacheName, maxEntries, maxAgeSeconds = 60 * 60 * 24 * 30) => new CacheFirst()

const sdk = {
  versioned: ['somesdks'],
  unversioned: ['somesdks'],
}

const registerSDKCache = () => {
  registerRoute(
    ({ request }) => sdk.versioned.some(r => request.url.includes(r)),
    cacheFirst('asset-sdk_versioned', 100)
  );
  registerRoute(
    ({ request }) => sdk.unversioned.some(r => request.url.includes(r)),
    staleWhileRevalidate('asset-sdk_unversioned', 100)
  );
};
  
const registerStaticAssetsCache = () => {
  registerRoute(({ request }) => ['image', 'font'].includes(request.destination), cacheFirst('asset-static', 100));
};
```

#### è¯·æ±‚

é¡µé¢åˆå§‹åŒ–ä¾èµ–çš„æ¥å£è¾ƒå¤šï¼Œå¯ä»¥ç¼“å­˜è¿™äº›è¯·æ±‚ï¼Œæ¥åŠ å¿«åˆå§‹åŒ–çš„é€Ÿåº¦ã€‚ä¾‹å¦‚ `xxx/xxxx/appInfo`ï¼Œè¿™ä¸ªæ¥å£è¿”å›ä¸€äº›é¡¹ç›®çš„é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ æƒé™ã€Oncall ç­‰ç­‰ã€‚æ ¹æ®ç›‘æ§å‘ç°ï¼Œè¿™ä¸ªè¯·æ±‚è¶…è¿‡ 1s çš„æ¯”ä¾‹è¾¾åˆ° 15%ï¼Œè€Œä¸”ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ã€‚ç›®å‰æ¥çœ‹ï¼Œè¿™ç±»è¯·æ±‚çš„ response æ•°æ®é•¿æ—¶é—´ä¸ä¼šæœ‰æ›´æ–°ï¼Œé€‰æ‹©ä½¿ç”¨ StaleWhileRevalidate çš„æ–¹å¼ç¼“å­˜èµ·æ¥ã€‚

```JavaScript
const requests = [
    '/xxxx/xxxx/appInfo',
    // others...
];

const registerRequestCache = () => {
  registerRoute(({ request }) => requests.some(r => request.url.includes(r)), staleWhileRevalidate('requests', 30));
};
```

#### App-shell

ç«™ç‚¹ä½¿ç”¨å¾®å‰ç«¯çš„æ¶æ„ï¼ŒåŠ è½½å„ä¸ªå­åº”ç”¨æœ‰ä¸€å®šè€—æ—¶ï¼Œå› æ­¤é€‰æ‹©ç¼“å­˜ä¸»å­åº”ç”¨çš„ App-shellï¼Œæ¥å‡å°‘ä¸»å­åº”ç”¨çš„ç½‘ç»œè¯·æ±‚æ—¶é•¿ï¼ŒåŠ å¿«æ•´ä¸ªåŠ è½½é“¾è·¯ã€‚

| é¡µé¢é“¾æ¥             | æè¿°               |
| -------------------- | ------------------ |
| https://xxxx/index   | ä¸»åº”ç”¨ index.html  |
| https://xxxx/subappA | å­åº”ç”¨A index.html |
| https://xxxx/subappB | å­åº”ç”¨B index.html |
| https://xxxx/subappC | å­åº”ç”¨C index.html |

```JavaScript
const registerNavigatorCache = () => {
  registerRoute(
    new NavigationRoute(staleWhileRevalidate('navigator', 100), {
      // match /path or /path/123
      allowlist: ['/', '/index', ...navigatePaths].map(path => new RegExp(`${path}/?[0-9]*$`)),
    })
  );
};
const registerSubAppCache = () => {
  const subAppShellRegex = new RegExp('xxxxx'); // app-shell router
  registerRoute(
    ({ request }) => subAppShellRegex.test(request.url), staleWhileRevalidate('subapp-shell', 10)
  );
};
```

æœ€ç»ˆ Service Worker çš„ç¼“å­˜ç»“æ„å¦‚ä¸‹ï¼š

```JavaScript
- asset-static // imageã€font
- asset-sdk_versioned // å¸¦ç‰ˆæœ¬å·çš„èµ„æº
- asset-sdk_unversioned // ä¸å¸¦ç‰ˆæœ¬çš„é™æ€èµ„æº
- workbox-precache // é¢„ç¼“å­˜æ•°æ® ï¼ˆbuild äº§ç‰©ï¼‰
- request // é…ç½®é¡¹çš„è¯·æ±‚
- navigator // SPA è·¯ç”±
- app-shell // åº”ç”¨çš„ index.html
```

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†å¼€å±çš„è¡”æ¥ Logoï¼Œç­‰å¾…ä¸»åº”ç”¨åŠ è½½å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡ä½¿ç”¨ä½“æ„Ÿã€‚ä¸ºäº†é˜²æ­¢ä¸»åº”ç”¨åŠ è½½å¿«å¯¼è‡´çš„é¢‘é—ªï¼Œè®¾ç½®äº†ä¸€ä¸ªæœ€å°çš„ Logo å»¶æ—¶æ˜¾ç¤ºï¼Œå¹¶ä¸ä¸»åº”ç”¨çš„åŠ è½½å¹¶å‘è¿›è¡Œã€‚

```JavaScript

const Layout = lazy(() =>
  // for fallback lading, delay 500ms at least to show the main layout
  Promise.all([import('../layout/index'), new Promise(resolve => setTimeout(resolve, 500))]).then(
    ([moduleExports]) => moduleExports
  )
);
```

### Service Worker æ³¨å†Œ

`sw.js` æ³¨å†Œåœ¨é¡µé¢çš„ load äº‹ä»¶ä¸­ï¼Œæ‰“ç‚¹è®°å½•ä¸€ä¸‹æ³¨å†Œæƒ…å†µã€‚

```JavaScript
<script>
  if('serviceWorker' in navigator){
    window.addEventListener('load', function() {
      navigator.serviceWorker
        .register('/sw.js')
        .then(function (reg) {
          // æ‰“ç‚¹è®°å½•æ³¨å†ŒçŠ¶æ€
        	// ... 
        })
        .catch(function (e) {
        });
    })
  }
</script>
```

### æ›´æ–°æ£€æµ‹

æˆ‘ä»¬å°è£…äº†ä¸€ä¸ªåŸç”Ÿçš„æ›´æ–°æ£€æµ‹å¼¹æ¡†ç»„ä»¶ï¼Œç»„ä»¶ä¼šç›‘å¬ Service Worker ç”Ÿå‘½å‘¨æœŸçš„äº‹ä»¶ï¼ˆåŒ…æ‹¬ updatefoundã€controllerchangeã€statechangeï¼‰ä»¥åŠ `message` äº‹ä»¶ï¼Œå¹¶æ ¹æ®ç”¨æˆ·çš„äº¤äº’è¿›è¡Œåˆ·æ–°ç¼“å­˜çš„æ“ä½œã€‚

![æ›´æ–°æ£€æµ‹æµç¨‹](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/screenshot-20220830-104418.png)

Service Worker æ›´æ–°æ£€æµ‹ç›‘å¬

```JavaScript
// sw.js
self.addEventListener("message", event => {
    if (event.data === "skipWaiting") {
       self.skipWaiting();
     }
});
// update-found.js
button.addEventListener('click', function() {
  registration.waiting.postMessage("skipWaiting");
})
navigator.serviceWorker.addEventListener("controllerchange", function(event) {
    window.location.reload();
});
// ...
registration.addEventListener("updatefound", function() {
  registration.installing.addEventListener("statechange", function(event) {
     if (event.target.state === "installed") {
        // å¼¹å‡ºæ›´æ–°æç¤ºæ¡†
         callback();
     }
  });
});
// ...
```

### é™çº§æ–¹æ¡ˆåŠç°åº¦å‘å¸ƒ

ä¸ºäº†é¿å…ç¼“å­˜å‡ºç°ä¸€äº›é—®é¢˜ï¼Œå¯¼è‡´é¡µé¢æ— æ³•åŠ è½½æˆ–è€…ç™½å±ä¹‹ç±»çš„é—®é¢˜ï¼Œéœ€è¦æä¾›ä¸€ä¸ª Service Worker æ³¨é”€çš„æ–¹æ¡ˆã€‚åœ¨åŠ¨æ€é…ç½®ä¸­å¿ƒä¸Šå¢åŠ ä¸€ä¸ª key ä½œä¸ºå¼€å…³ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶è¯·æ±‚é…ç½®ï¼Œæ ¹æ®é…ç½®é€‰æ‹©æ³¨å†Œæ›´æ–° Service Worker è¿˜æ˜¯æ³¨é”€æ‰€æœ‰çš„ Service Workerã€‚å¦å¤–é…ç½®ä¸­è¿˜åŒ…å«ç°åº¦çš„åœ°åŒºï¼Œåªæœ‰é€‰æ‹©å¯¹åº”çš„ç°åº¦åœ°åŒºæ‰ä¼šæ³¨å†Œ Service Workerã€‚

```JavaScript
// tcc api
FETCH_CONFIG: `/xxxx/getconfig/`;
window.addEventListener("load", () => {
  fetch(FETCH_CONFIG)
    .then(function (res) {
      return res.json();
    })
    .then(function (res) {
        var configData = res && res.data && JSON.parse(res.data);
        if (configData && (configData.pwaDisabled || !configData.pwaEnableRegion.includes(regionName))) {
            // æ³¨é”€ service worker
            enableServiceWorker = false;
        }
    })
    .finally(function () {
        if (enableServiceWorker) {
            // æ³¨å†Œ service worker
        }
    })
});

// æ‰“ç‚¹è®°å½•
```

## æ”¶ç›Šä»¥åŠåé¦ˆ

é€šè¿‡æ­¤æ¬¡ PWA çš„æ”¹é€ ï¼Œç«™ç‚¹æ•´ä½“çš„ FCPã€Load ä»¥åŠæ…¢è¯·æ±‚ç‡æŒ‡æ ‡æœ‰äº†æ˜æ˜¾çš„æ”¹å–„ï¼Œè¾¾åˆ°äº†é¢„æœŸå€¼ã€‚

|         | FCP       | Load  | Main Resource Slow Request Rate |
| ------- | --------- | ----- | ------------------------------- |
| Before  | 2115.38ms | 2.42s | 11.29%                          |
| After   | 1388.06ms | 1.16  | 5.37%                           |
| Percent | ğŸ”º52%      | ğŸ”º240% | ğŸ”»52.4%                          |

ä½† LCPã€TTI ç­‰æŒ‡æ ‡ä»è¾ƒé«˜ï¼Œåç»­ä¼šè¿›ä¸€æ­¥ä»ä»£ç é€»è¾‘å±‚é¢å’Œæ‰“åŒ…å±‚é¢åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œæå‡äº¤äº’ä½“éªŒã€‚

-   ä»ä»£ç é€»è¾‘å±‚é¢ï¼Œå¯¹é¡µé¢æ¸²æŸ“ã€å›¾ç‰‡åŠ è½½ã€å‡å°‘ long task ç­‰æ–¹é¢è¿›è¡Œä¼˜åŒ–
    
-   æ‰“åŒ…å±‚é¢ï¼Œåˆç†æ‹†åŒ…ï¼Œå»é™¤ä¸å¿…è¦çš„åŒ…ç­‰ç­‰æ–¹é¢
    
å¦å¤–ï¼ŒåŠŸèƒ½ä¸Šçº¿åï¼Œæˆ‘ä»¬ä¹Ÿæ”¶åˆ°äº†æ¥è‡ª PMã€RD ä»¥åŠç›¸å…³ç”¨æˆ·çš„ä¸€äº›æ­£å‘åé¦ˆï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯è«å¤§çš„é¼“èˆã€‚æˆ‘ä»¬ä¹Ÿä¼šæŒç»­å…³æ³¨æ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–ï¼ŒæŒç»­ç²¾è¿›ã€‚

æœ€åæ’å…¥ä¸€åˆ™å¹¿å‘Šï¼ŒTikTok Creator Growth å›¢é˜Ÿä»åœ¨æ‹›è˜å‰åç«¯å·¥ç¨‹å¸ˆï¼Œæ ¡æ‹›å’Œç¤¾æ‹›å‡å¯ï¼Œæœ‰æ„å‘çš„åŒå­¦å¯ä»¥åŠ å¾®ä¿¡ç»†èŠ ğŸ™ã€‚

![](https://mayandev.oss-cn-hangzhou.aliyuncs.com/upicBlog/IMG_4504.JPG)